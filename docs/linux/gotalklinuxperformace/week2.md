# CPU性能

## 遇到的各种问题

## 工具背后要看什么

### perf
Tracepoint 是散落在内核源代码中的一些 hook，一旦使能，它们便可以在特定的代码被运行到时被触发，
这一特性可以被各种 trace/debug 工具所使用。Perf 就是该特性的用户之一。内核发出一些事件，Perf
能够知道这会儿程序运行在哪里，只要事件足够，就能知道程序运行事件的百分比。

`perf list`可以列出所有的采样点事件,主要分成三类
- Hardware Event 是由 PMU 硬件产生的事件，比如 cache 命中，当您需要了解程序对硬件特性的使用情况时，便需要对这些事件进行采样；
- Software Event 是内核软件产生的事件，比如进程切换，tick 数等 ;
- Tracepoint event 是内核中的静态 tracepoint 所触发的事件，这些 tracepoint 用来判断程序运行期间内核的行为细节，比如 slab 分配器的分配次数等。

### [sar](https://man.linuxde.net/sar)
sar命令是Linux下系统运行状态统计工具，
它将指定的操作系统状态计数器显示到标准输出设备。sar工具将对系统当前的状态进行取样，然后通过计算数据和比例来表达系统的当前运行状态。它的特点是可以连续对系统取样，获得大量的取样数据。取样数据和分析的结果都可以存入文件，使用它时消耗的系统资源很小。

## 操作系统概念

### 软中断
中断是系统用来响应硬件设备请求的一种机制，它会打断进程的正常调度和执行，然后调用内核中的中断处理程序来响应设备的请求。
- 中断是一种异步事件处理机制
- 中断会关闭中断响应(中断丢失)
- 为了减少中断事件，将中断两阶段
    - 上半部快速处理，中断禁止模式，处理硬件紧密和事件敏感相关 （硬）
    - 延迟处理，以内核线程运行 (软)
- 查看`/proc/softirqs` `/proc/interrupts`


### RCU（宽限期）
- 在读取过程中，另外一个线程删除了一个节点。删除线程可以把这个节点从链表中移除，但它不能直接销毁这个节点，必须等到所有的读取线程读取完成以后，才进行销毁操作。RCU中把这个过程称为宽限期（Grace period）。
- 在读取过程中，另外一个线程插入了一个新节点，而读线程读到了这个节点，那么需要保证读到的这个节点是完整的。这里涉及到了发布-订阅机制（Publish-Subscribe Mechanism）。
- 保证读取链表的完整性。新增或者删除一个节点，不至于导致遍历一个链表从中间断开。但是RCU并不保证一定能读到新增的节点或者不读到要被删除的节点。


## 思路
- 知道CPU的性能指标
- 知道有哪些工具可以查看这些指标
- 明白指标的关联性，用几个工具缩小查找范围

## 真实世界

#### perf如何分析Python程序
对于Python程序，所有执行逻辑其实是Cpython去执行python字节码。对于这种有虚拟机的语言，如何用Perf
进行分析呢？