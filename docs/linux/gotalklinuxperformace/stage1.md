# CPU性能 

## 遇到的各种问题

#### 在`mac`使用`uptime`里面看到`3user`
这个登陆是用户登陆的次数. 而不是登陆用户的数量。所以重复的登陆会让`user`增加，而每次打开`terminal`都会登陆一次

#### `centos7`的`sysstat`没有`%wait`
```shell
# 升级到11.5.5 以上
wget -c http://pagesperso-orange.fr/sebastien.godard/sysstat-11.7.3-1.x86_64.rpm
sudo rpm -Uvh sysstat-11.7.3-1.x86_64.rpm
```

## 工具背后要看什么

### [uptime](https://man.linuxde.net/uptime)

平均负载提供了一个快速查看系统整体性能的手段，反映了整体的负载情况。
但只看平均负载本身，我们并不能直接发现，到底是哪里出现了瓶颈。有点系统健康度的味道，
很多时候我首先要知道你健康还是不健康
- 平均负载是什么: 平均活跃进程(可运行状态/不可中断状态)
    - 可运行状态 TOP R 的状态
    - 不可中断状态 硬件交互， 被`vfork`的父进程
- 引起负载升高的原因: CPU使用率高/IO繁忙



### [vmstat](https://man.linuxde.net/vmstat)



## 操作系统概念

#### 什么是进程/什么是线程
- 进程是资源的载体，是操作系统对于资源的虚拟化
- 内核线程是操作系统调度的单元
- 用户线程对操作系统不可见

#### 上下文切换-:dragon_face:
进程切换 > 线程切换 > 系统调用 > 函数调用 
- 系统调用： 进程运行在用户空间，通过系统调用陷入内核空间，实际上是一个权限切换
- 进程切换： 用户空间的(栈/全局变量/虚拟内存)，内核堆栈，寄存器 （20ns-1μs）
- 线程切换： 虚拟内存不用动，内核堆栈不用动，线程私有数据，寄存器等不共享的数据
- 中断上下文切换：中断是内核的事情，不影响用户空间的事情。只需要保存内核堆栈/寄存器/硬件中断参数

### 自愿与非自愿上下文切换
`pidstat -wt  1`然后 `cat /proc/interrupts`
- 上下文切换100-10000都是很正常的，只要不是激增
- 自愿上下文切换变多了，说明进程都在等待资源，
- 有可能发生了 I/O 等其他问题；非自愿上下文切换变多了，
- 说明进程都在被强制调度，也就是都在争抢 CPU，说明 CPU 的确成了瓶颈；
- 中断次数变多了，说明 CPU 被中断处理程序占用，

### CPU使用率
`top`
- CPU没有时间的概念，只有时钟的概念，只能说这是第几个tic/tok
- 使用率就是`1 - 空闲时间/总CPU时间`
- 平均CPU使用率  `1 - (new_free - old_free) / (new_total - old_total)`


## 思路

### CPU使用率高
- 用户 CPU 和 Nice CPU 高，说明用户态进程占用了较多的 CPU，所以应该着重排查进程的性能问题。
- 系统 CPU 高，说明内核态占用了较多的 CPU，所以应该着重排查内核线程或者系统调用的性能问题。
- I/O 等待 CPU 高，说明等待 I/O 的时间比较长，所以应该着重排查系统存储是不是出现了 I/O 问题。
- 软中断和硬中断高，说明软中断或硬中断的处理程序占用了较多的 CPU，所以应该着重排查内核中的中断服务程序。
- 碰到 CPU 使用率升高的问题，你可以借助 top、pidstat 等工具，确认引发 CPU 性能问题的来源；再使用 perf 等工具，排查出引起性能问题的具体函数。


## 实操问题
- Prometheus CPU 老是100%,用pidstat perf观察，和用gopprof观察，分析问题的思路有啥相似的地方
 






